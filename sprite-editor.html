<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактор Sprites.json - Конструктор голубей</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
            font-size: 2em;
        }

        .header p {
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 80vh;
        }

        .sidebar {
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .file-button:hover {
            background: #0056b3;
        }

        .body-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .body-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .body-item:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .body-item.active {
            border-color: #007bff;
            background: #e6f3ff;
        }

        .body-preview {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-right: 10px;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .body-name {
            flex: 1;
            font-weight: 500;
        }

        .segments-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .segment-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }

        .segment-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .segment-icon {
            font-size: 16px;
        }

        .segment-name {
            font-size: 14px;
            font-weight: 500;
        }

        .delete-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-button:hover {
            background: #c82333;
        }

        .add-segment {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .add-segment input,
        .add-segment select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .add-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-button:hover {
            background: #218838;
        }

        .canvas-area {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .canvas-container {
            position: relative;
            display: inline-block;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
        }

        .base-body-image {
            max-width: 400px;
            max-height: 500px;
            display: block;
        }

        .segment-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            background: rgba(0, 123, 255, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            user-select: none;
            transform: translate(-50%, -50%);
            z-index: 20;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .segment-marker:hover {
            background: rgba(0, 123, 255, 1);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .segment-marker.dragging {
            background: rgba(255, 193, 7, 0.9);
            border-color: #ffc107;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }

        .highlight-area {
            position: absolute;
            border: 2px dashed rgba(0, 123, 255, 0.5);
            background: rgba(0, 123, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            pointer-events: none;
            z-index: 10;
        }

        .highlight-area.selected {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.2);
            pointer-events: auto;
        }

        .resize-handle {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 16px solid transparent;
            border-bottom: 16px solid #007bff;
            cursor: se-resize;
            z-index: 15;
            transition: all 0.2s ease;
        }

        .resize-handle:hover {
            border-bottom-color: #0056b3;
            transform: scale(1.15);
        }

        .resize-handle:before {
            content: '';
            position: absolute;
            top: 3px;
            left: -11px;
            width: 0;
            height: 0;
            border-left: 11px solid transparent;
            border-bottom: 11px solid white;
        }

        .resize-handle:after {
            content: '⤡';
            position: absolute;
            top: -8px;
            left: -12px;
            font-size: 10px;
            color: #007bff;
            font-weight: bold;
            pointer-events: none;
        }

        .canvas-info {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 500px;
        }

        .canvas-info h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .coordinates {
            font-family: monospace;
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }

        .export-import {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-button,
        .import-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-button {
            background: #28a745;
            color: white;
        }

        .export-button:hover {
            background: #218838;
        }

        .import-button {
            background: #17a2b8;
            color: white;
        }

        .import-button:hover {
            background: #138496;
        }

        .no-body-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #6c757d;
            font-size: 18px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .decorative-elements {
            max-height: 300px;
            overflow-y: auto;
        }

        .element-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .element-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .element-preview {
            width: 20px;
            height: 20px;
            object-fit: contain;
            background: #f8f9fa;
            border-radius: 2px;
        }

        .segment-type {
            font-size: 10px;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            color: #6c757d;
        }

        .scale-section {
            margin-bottom: 20px;
        }

        .scale-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .scale-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .scale-control input[type="range"] {
            flex: 1;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .scale-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
        }

        .scale-control input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .scale-control span {
            min-width: 40px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #6c757d;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .scale-group {
            margin-bottom: 15px;
        }

        .scale-group label {
            font-size: 13px;
            margin-bottom: 5px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🐦 Редактор Sprites.json</h1>
            <p>Настройка сегментов и позиций для конструктора голубей</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <!-- Импорт/Экспорт -->
                <div class="panel">
                    <h3>Файл конфигурации</h3>
                    
                    <!-- Настройка пути к спрайтам -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #6c757d;">Базовый путь к спрайтам:</label>
                        <select id="spritePath" onchange="updateSpritePath()" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                            <option value="public/sprites/">public/sprites/ (локально)</option>
                            <option value="/sprites/">/sprites/ (на сервере)</option>
                            <option value="./sprites/">./sprites/ (относительный)</option>
                            <option value="../public/sprites/">../public/sprites/ (из src)</option>
                        </select>
                    </div>
                    
                    <div class="file-input-wrapper">
                        <input type="file" id="importFile" class="file-input" accept=".json">
                        <button class="file-button" onclick="document.getElementById('importFile').click()">
                            📂 Загрузить sprites.json
                        </button>
                    </div>
                    <div class="export-import">
                        <button class="export-button" onclick="exportConfig()">💾 Экспорт</button>
                        <button class="import-button" onclick="document.getElementById('importFile').click()">📥 Импорт</button>
                    </div>
                </div>

                <!-- Базовые тела -->
                <div class="panel">
                    <h3>Базовые тела</h3>
                    <div class="body-list" id="bodyList">
                        <!-- Тела будут добавлены динамически -->
                    </div>
                    <div class="add-segment">
                        <input type="text" id="newBodyName" placeholder="Название тела">
                        <button class="add-button" onclick="addNewBody()">+</button>
                    </div>
                </div>

                <!-- Сегменты -->
                <div class="panel">
                    <h3>Сегменты</h3>
                    <div class="segments-list" id="segmentsList">
                        <!-- Сегменты будут добавлены динамически -->
                    </div>
                    <div class="add-segment">
                        <input type="text" id="newSegmentName" placeholder="Название сегмента">
                        <button class="add-button" onclick="addNewSegment()">+</button>
                    </div>
                </div>

                <!-- Настройки масштабирования -->
                <div class="panel" id="scalePanel" style="display: none;">
                    <h3>Масштабирование</h3>
                    
                    <!-- Масштаб базового тела -->
                    <div class="scale-section">
                        <label>Масштаб тела:</label>
                        <div class="scale-control">
                            <input type="range" id="bodyScale" min="0.5" max="2" step="0.1" value="1" onchange="updateBodyScale(this.value)">
                            <span id="bodyScaleValue">1.0</span>
                        </div>
                    </div>

                    <!-- Настройки выбранного сегмента -->
                    <div class="scale-section" id="segmentScaleSection" style="display: none;">
                        <label id="selectedSegmentLabel">Выбранный сегмент:</label>
                        
                        <div class="scale-group">
                            <label>Ширина области:</label>
                            <div class="scale-control">
                                <input type="range" id="segmentWidth" min="20" max="200" step="5" onchange="updateSegmentSize()">
                                <span id="segmentWidthValue">0</span>
                            </div>
                        </div>
                        
                        <div class="scale-group">
                            <label>Высота области:</label>
                            <div class="scale-control">
                                <input type="range" id="segmentHeight" min="20" max="200" step="5" onchange="updateSegmentSize()">
                                <span id="segmentHeightValue">0</span>
                            </div>
                        </div>

                        <button class="add-button" onclick="resetSegmentSize()" style="width: 100%; margin-top: 10px;">
                            Сбросить размер
                        </button>
                    </div>
                </div>

                <!-- Декоративные элементы -->
                <div class="panel">
                    <h3>Декоративные элементы</h3>
                    <div class="decorative-elements" id="decorativeElements">
                        <!-- Элементы будут добавлены динамически -->
                    </div>
                    <div class="add-segment">
                        <input type="text" id="newElementName" placeholder="Название элемента">
                        <select id="newElementSegment" style="flex: 1; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <option value="head">Голова</option>
                            <option value="wing">Крыло</option>
                        </select>
                        <button class="add-button" onclick="addNewDecorativeElement()">+</button>
                    </div>
                </div>
            </div>

            <div class="canvas-area">
                <div class="canvas-container" id="canvasContainer">
                    <div class="no-body-selected" id="noBodySelected">
                        Выберите базовое тело для редактирования
                    </div>
                    <!-- Изображение и маркеры будут добавлены динамически -->
                </div>

                    <div class="canvas-info" id="canvasInfo" style="display: none;">
                    <h4>Информация о сегментах</h4>
                    <div class="canvas-controls-info" style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 6px; padding: 10px; margin-bottom: 15px; font-size: 12px; color: #1565c0;">
                        💡 <strong>Управление:</strong><br>
                        🔵 Синий круг = перетаскивание позиции<br>
                        🔶 Треугольник = изменение размера<br>
                        🎯 Клик по области = выбор сегмента
                    </div>
                    <div class="coordinates" id="coordinatesInfo">
                        <!-- Координаты будут обновляться динамически -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let spritesData = {
            baseBodies: {},
            decorativeElements: {}
        };
        let currentBodyId = null;
        let selectedSegmentId = null;
        let isDragging = false;
        let isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        let resizeData = { startX: 0, startY: 0, startWidth: 0, startHeight: 0 };
        let spritesBasePath = 'public/sprites/';

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultConfig();
            setupFileInput();
        });

        function loadDefaultConfig() {
            // Загружаем базовую конфигурацию
            spritesData = {
                baseBodies: {
                    "body1": {
                        "id": "body1",
                        "name": "Классический голубь",
                        "sprite": spritesBasePath + "base-bodies/body1.png",
                        "segments": {
                            "head": {
                                "id": "head",
                                "name": "Голова",
                                "icon": "🐦",
                                "attachmentPoint": { "x": 120, "y": 60 },
                                "highlightArea": { "x": 100, "y": 40, "width": 80, "height": 80 }
                            },
                            "wing": {
                                "id": "wing",
                                "name": "Крыло",
                                "icon": "🪶",
                                "attachmentPoint": { "x": 80, "y": 120 },
                                "highlightArea": { "x": 60, "y": 100, "width": 100, "height": 80 }
                            }
                        }
                    },
                    "body2": {
                        "id": "body2",
                        "name": "Городской голубь",
                        "sprite": spritesBasePath + "base-bodies/body2.png",
                        "segments": {
                            "head": {
                                "id": "head",
                                "name": "Голова",
                                "icon": "🐦",
                                "attachmentPoint": { "x": 110, "y": 55 },
                                "highlightArea": { "x": 90, "y": 35, "width": 75, "height": 75 }
                            },
                            "wing": {
                                "id": "wing",
                                "name": "Крыло",
                                "icon": "🪶",
                                "attachmentPoint": { "x": 75, "y": 115 },
                                "highlightArea": { "x": 55, "y": 95, "width": 95, "height": 75 }
                            }
                        }
                    }
                },
                decorativeElements: {
                    "crown": {
                        "id": "crown",
                        "name": "Корона",
                        "sprite": spritesBasePath + "decorative/crown.png",
                        "segmentType": "head"
                    },
                    "hat": {
                        "id": "hat",
                        "name": "Шляпа",
                        "sprite": spritesBasePath + "decorative/hat.png",
                        "segmentType": "head"
                    },
                    "bow": {
                        "id": "bow",
                        "name": "Бантик",
                        "sprite": spritesBasePath + "decorative/bow.png",
                        "segmentType": "wing"
                    },
                    "ribbon": {
                        "id": "ribbon",
                        "name": "Лента",
                        "sprite": spritesBasePath + "decorative/ribbon.png",
                        "segmentType": "wing"
                    }
                }
            };
            
            updateBodyList();
            updateDecorativeElements();
        }

        function setupFileInput() {
            document.getElementById('importFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            spritesData = JSON.parse(e.target.result);
                            updateBodyList();
                            updateDecorativeElements();
                            if (currentBodyId) {
                                selectBody(currentBodyId);
                            }
                            alert('Конфигурация успешно загружена!');
                        } catch (error) {
                            alert('Ошибка при загрузке файла: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            });
        }

        function updateBodyList() {
            const bodyList = document.getElementById('bodyList');
            bodyList.innerHTML = '';

            Object.values(spritesData.baseBodies).forEach(body => {
                const bodyItem = document.createElement('div');
                bodyItem.className = `body-item ${currentBodyId === body.id ? 'active' : ''}`;
                bodyItem.onclick = () => selectBody(body.id);
                
                bodyItem.innerHTML = `
                    <img src="${body.sprite}" alt="${body.name}" class="body-preview" onerror="this.style.display='none'">
                    <span class="body-name">${body.name}</span>
                    <button class="delete-button" onclick="event.stopPropagation(); deleteBody('${body.id}')">×</button>
                `;
                
                bodyList.appendChild(bodyItem);
            });
        }

        function updateDecorativeElements() {
            const elementsContainer = document.getElementById('decorativeElements');
            elementsContainer.innerHTML = '';

            Object.values(spritesData.decorativeElements).forEach(element => {
                const elementItem = document.createElement('div');
                elementItem.className = 'element-item';
                
                elementItem.innerHTML = `
                    <div class="element-info">
                        <img src="${element.sprite}" alt="${element.name}" class="element-preview" onerror="this.style.display='none'">
                        <span>${element.name}</span>
                        <span class="segment-type">${element.segmentType}</span>
                    </div>
                    <button class="delete-button" onclick="deleteDecorativeElement('${element.id}')">×</button>
                `;
                
                elementsContainer.appendChild(elementItem);
            });
        }

        function selectBody(bodyId) {
            currentBodyId = bodyId;
            selectedSegmentId = null;
            const body = spritesData.baseBodies[bodyId];
            
            updateBodyList();
            updateSegmentsList();
            renderBodyCanvas(body);
            updateCanvasInfo();
            showScalePanel();
            updateScaleControls();
        }

        function renderBodyCanvas(body) {
            const container = document.getElementById('canvasContainer');
            const noBodySelected = document.getElementById('noBodySelected');
            
            container.innerHTML = '';
            
            // Создаем изображение тела
            const img = document.createElement('img');
            img.src = body.sprite;
            img.className = 'base-body-image';
            img.alt = body.name;
            
            // Применяем масштаб, если есть
            if (body.scale) {
                img.style.transform = `scale(${body.scale})`;
                img.style.transformOrigin = 'top left';
            }
            
            img.onload = function() {
                container.appendChild(img);
                renderSegmentMarkers(body);
            };
            
            img.onerror = function() {
                const placeholder = document.createElement('div');
                placeholder.style.width = '300px';
                placeholder.style.height = '400px';
                placeholder.style.background = '#f8f9fa';
                placeholder.style.border = '2px dashed #dee2e6';
                placeholder.style.display = 'flex';
                placeholder.style.alignItems = 'center';
                placeholder.style.justifyContent = 'center';
                placeholder.style.color = '#6c757d';
                placeholder.textContent = 'Изображение не найдено';
                container.appendChild(placeholder);
                renderSegmentMarkers(body);
            };
        }

        function renderSegmentMarkers(body) {
            const container = document.getElementById('canvasContainer');
            
            Object.values(body.segments).forEach(segment => {
                // Создаем область подсветки сначала (чтобы она была под маркером)
                if (segment.highlightArea) {
                    const highlight = document.createElement('div');
                    highlight.className = `highlight-area ${selectedSegmentId === segment.id ? 'selected' : ''}`;
                    highlight.style.left = segment.highlightArea.x + 'px';
                    highlight.style.top = segment.highlightArea.y + 'px';
                    highlight.style.width = segment.highlightArea.width + 'px';
                    highlight.style.height = segment.highlightArea.height + 'px';
                    highlight.dataset.segmentId = segment.id;
                    highlight.title = `Область: ${segment.name}`;
                    
                    // Добавляем клик для выбора сегмента только для неактивных областей
                    if (selectedSegmentId !== segment.id) {
                        highlight.style.pointerEvents = 'auto';
                        highlight.addEventListener('click', function(e) {
                            e.preventDefault();
                            selectSegment(segment.id);
                        });
                    }
                    
                    container.appendChild(highlight);
                    
                    // Добавляем треугольную ручку изменения размера для выбранного сегмента
                    if (selectedSegmentId === segment.id) {
                        const resizeHandle = document.createElement('div');
                        resizeHandle.className = 'resize-handle';
                        resizeHandle.style.left = (segment.highlightArea.x + segment.highlightArea.width) + 'px';
                        resizeHandle.style.top = (segment.highlightArea.y + segment.highlightArea.height) + 'px';
                        resizeHandle.dataset.segmentId = segment.id;
                        
                        setupResizeHandle(resizeHandle, segment);
                        
                        container.appendChild(resizeHandle);
                    }
                }

                // Создаем маркер точки крепления в центре области (поверх всего)
                const marker = document.createElement('div');
                marker.className = 'segment-marker';
                marker.textContent = segment.icon;
                marker.dataset.segmentId = segment.id;
                marker.title = segment.name;
                
                // Позиционируем маркер в центре области подсветки, если она есть
                if (segment.highlightArea) {
                    const centerX = segment.highlightArea.x + segment.highlightArea.width / 2;
                    const centerY = segment.highlightArea.y + segment.highlightArea.height / 2;
                    marker.style.left = centerX + 'px';
                    marker.style.top = centerY + 'px';
                    
                    // Обновляем attachmentPoint чтобы он совпадал с центром
                    segment.attachmentPoint.x = centerX;
                    segment.attachmentPoint.y = centerY;
                } else {
                    marker.style.left = segment.attachmentPoint.x + 'px';
                    marker.style.top = segment.attachmentPoint.y + 'px';
                }
                
                // Добавляем drag and drop
                setupDragAndDrop(marker, segment);
                
                container.appendChild(marker);
            });
        }

        function setupDragAndDrop(marker, segment) {
            marker.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation(); // Предотвращаем всплытие к области подсветки
                isDragging = true;
                marker.classList.add('dragging');
                
                const rect = marker.getBoundingClientRect();
                const containerRect = document.getElementById('canvasContainer').getBoundingClientRect();
                
                dragOffset.x = e.clientX - rect.left - rect.width / 2;
                dragOffset.y = e.clientY - rect.top - rect.height / 2;
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            
            function onMouseMove(e) {
                if (!isDragging) return;
                
                const containerRect = document.getElementById('canvasContainer').getBoundingClientRect();
                const centerX = Math.max(0, e.clientX - containerRect.left - dragOffset.x);
                const centerY = Math.max(0, e.clientY - containerRect.top - dragOffset.y);
                
                marker.style.left = centerX + 'px';
                marker.style.top = centerY + 'px';
                
                // Обновляем область подсветки, если она есть
                if (segment.highlightArea) {
                    const halfWidth = segment.highlightArea.width / 2;
                    const halfHeight = segment.highlightArea.height / 2;
                    
                    segment.highlightArea.x = centerX - halfWidth;
                    segment.highlightArea.y = centerY - halfHeight;
                    
                    // Обновляем отображение области
                    const highlight = document.querySelector(`[data-segment-id="${segment.id}"].highlight-area`);
                    if (highlight) {
                        highlight.style.left = segment.highlightArea.x + 'px';
                        highlight.style.top = segment.highlightArea.y + 'px';
                    }
                    
                    // Обновляем ручку изменения размера, если сегмент выбран
                    if (selectedSegmentId === segment.id) {
                        const resizeHandle = document.querySelector(`[data-segment-id="${segment.id}"].resize-handle`);
                        if (resizeHandle) {
                            resizeHandle.style.left = (segment.highlightArea.x + segment.highlightArea.width) + 'px';
                            resizeHandle.style.top = (segment.highlightArea.y + segment.highlightArea.height) + 'px';
                        }
                    }
                }
            }
            
            function onMouseUp(e) {
                if (!isDragging) return;
                
                isDragging = false;
                marker.classList.remove('dragging');
                
                const containerRect = document.getElementById('canvasContainer').getBoundingClientRect();
                const centerX = Math.max(0, e.clientX - containerRect.left - dragOffset.x);
                const centerY = Math.max(0, e.clientY - containerRect.top - dragOffset.y);
                
                // Обновляем данные сегмента
                segment.attachmentPoint.x = Math.round(centerX);
                segment.attachmentPoint.y = Math.round(centerY);
                
                if (segment.highlightArea) {
                    const halfWidth = segment.highlightArea.width / 2;
                    const halfHeight = segment.highlightArea.height / 2;
                    
                    segment.highlightArea.x = Math.round(centerX - halfWidth);
                    segment.highlightArea.y = Math.round(centerY - halfHeight);
                }
                
                updateCanvasInfo();
                
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        }

        function updateSegmentsList() {
            const segmentsList = document.getElementById('segmentsList');
            segmentsList.innerHTML = '';
            
            if (!currentBodyId) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            Object.values(body.segments).forEach(segment => {
                const segmentItem = document.createElement('div');
                segmentItem.className = 'segment-item';
                
                segmentItem.innerHTML = `
                    <div class="segment-info">
                        <span class="segment-icon">${segment.icon}</span>
                        <span class="segment-name">${segment.name}</span>
                    </div>
                    <button class="delete-button" onclick="deleteSegment('${segment.id}')">×</button>
                `;
                
                segmentsList.appendChild(segmentItem);
            });
        }

        function updateCanvasInfo() {
            const canvasInfo = document.getElementById('canvasInfo');
            const coordinatesInfo = document.getElementById('coordinatesInfo');
            
            if (!currentBodyId) {
                canvasInfo.style.display = 'none';
                return;
            }
            
            canvasInfo.style.display = 'block';
            
            const body = spritesData.baseBodies[currentBodyId];
            let info = `Базовое тело: ${body.name}\n`;
            
            if (body.scale && body.scale !== 1.0) {
                info += `Масштаб: ${body.scale}\n`;
            }
            
            info += `Путь к спрайтам: ${spritesBasePath}\n`;
            info += '\n';
            
            Object.values(body.segments).forEach(segment => {
                const isSelected = selectedSegmentId === segment.id;
                const marker = isSelected ? '► ' : '  ';
                
                info += `${marker}${segment.name} (${segment.icon}):\n`;
                info += `  attachmentPoint: { x: ${segment.attachmentPoint.x}, y: ${segment.attachmentPoint.y} }\n`;
                if (segment.highlightArea) {
                    info += `  highlightArea: { x: ${segment.highlightArea.x}, y: ${segment.highlightArea.y}, width: ${segment.highlightArea.width}, height: ${segment.highlightArea.height} }\n`;
                }
                info += '\n';
            });
            
            if (selectedSegmentId) {
                info += `\n💡 Выбран сегмент: ${body.segments[selectedSegmentId]?.name}\n`;
                info += `Кликните на область или используйте ручку изменения размера`;
            }
            
            coordinatesInfo.textContent = info;
        }

        function addNewSegment() {
            const input = document.getElementById('newSegmentName');
            const name = input.value.trim();
            
            if (!name || !currentBodyId) return;
            
            const segmentId = name.toLowerCase().replace(/\s+/g, '_');
            const body = spritesData.baseBodies[currentBodyId];
            
            if (body.segments[segmentId]) {
                alert('Сегмент с таким именем уже существует');
                return;
            }
            
            body.segments[segmentId] = {
                id: segmentId,
                name: name,
                icon: '📍',
                attachmentPoint: { x: 100, y: 100 },
                highlightArea: { x: 80, y: 80, width: 40, height: 40 }
            };
            
            input.value = '';
            updateSegmentsList();
            renderBodyCanvas(body);
            updateCanvasInfo();
        }

        function deleteSegment(segmentId) {
            if (!currentBodyId || !confirm('Удалить сегмент?')) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            delete body.segments[segmentId];
            
            updateSegmentsList();
            renderBodyCanvas(body);
            updateCanvasInfo();
        }

        function addNewBody() {
            const input = document.getElementById('newBodyName');
            const name = input.value.trim();
            
            if (!name) return;
            
            const bodyId = 'body_' + Date.now();
            
            spritesData.baseBodies[bodyId] = {
                id: bodyId,
                name: name,
                sprite: spritesBasePath + 'base-bodies/' + bodyId + '.png',
                segments: {}
            };
            
            input.value = '';
            updateBodyList();
            selectBody(bodyId);
        }

        function deleteBody(bodyId) {
            if (!confirm('Удалить базовое тело?')) return;
            
            delete spritesData.baseBodies[bodyId];
            
            if (currentBodyId === bodyId) {
                currentBodyId = null;
                document.getElementById('canvasContainer').innerHTML = '<div class="no-body-selected">Выберите базовое тело для редактирования</div>';
                document.getElementById('canvasInfo').style.display = 'none';
                updateSegmentsList();
            }
            
            updateBodyList();
        }

        function deleteDecorativeElement(elementId) {
            if (!confirm('Удалить декоративный элемент?')) return;
            
            delete spritesData.decorativeElements[elementId];
            updateDecorativeElements();
        }

        function exportConfig() {
            const dataStr = JSON.stringify(spritesData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'sprites.json';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        function showScalePanel() {
            document.getElementById('scalePanel').style.display = 'block';
        }

        function updateScaleControls() {
            if (!currentBodyId) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            const bodyScaleSlider = document.getElementById('bodyScale');
            const bodyScaleValue = document.getElementById('bodyScaleValue');
            
            // Инициализируем масштаб тела, если его нет
            if (!body.scale) {
                body.scale = 1.0;
            }
            
            bodyScaleSlider.value = body.scale;
            bodyScaleValue.textContent = body.scale.toFixed(1);
            
            updateSegmentScaleControls();
        }

        function updateSegmentScaleControls() {
            const segmentScaleSection = document.getElementById('segmentScaleSection');
            
            if (!selectedSegmentId || !currentBodyId) {
                segmentScaleSection.style.display = 'none';
                return;
            }
            
            const body = spritesData.baseBodies[currentBodyId];
            const segment = body.segments[selectedSegmentId];
            
            if (!segment || !segment.highlightArea) {
                segmentScaleSection.style.display = 'none';
                return;
            }
            
            segmentScaleSection.style.display = 'block';
            
            document.getElementById('selectedSegmentLabel').textContent = `${segment.name} (${segment.icon}):`;
            
            const widthSlider = document.getElementById('segmentWidth');
            const heightSlider = document.getElementById('segmentHeight');
            const widthValue = document.getElementById('segmentWidthValue');
            const heightValue = document.getElementById('segmentHeightValue');
            
            widthSlider.value = segment.highlightArea.width;
            heightSlider.value = segment.highlightArea.height;
            widthValue.textContent = segment.highlightArea.width + 'px';
            heightValue.textContent = segment.highlightArea.height + 'px';
        }

        function selectSegment(segmentId) {
            selectedSegmentId = segmentId;
            if (currentBodyId) {
                renderBodyCanvas(spritesData.baseBodies[currentBodyId]);
                updateSegmentScaleControls();
            }
        }

        function updateBodyScale(scale) {
            if (!currentBodyId) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            body.scale = parseFloat(scale);
            
            document.getElementById('bodyScaleValue').textContent = scale;
            
            // Применяем масштаб к изображению
            const img = document.querySelector('.base-body-image');
            if (img) {
                img.style.transform = `scale(${scale})`;
                img.style.transformOrigin = 'top left';
            }
        }

        function updateSegmentSize() {
            if (!selectedSegmentId || !currentBodyId) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            const segment = body.segments[selectedSegmentId];
            
            if (!segment || !segment.highlightArea) return;
            
            const newWidth = parseInt(document.getElementById('segmentWidth').value);
            const newHeight = parseInt(document.getElementById('segmentHeight').value);
            
            // Сохраняем центральную точку (где находится маркер)
            const centerX = segment.highlightArea.x + segment.highlightArea.width / 2;
            const centerY = segment.highlightArea.y + segment.highlightArea.height / 2;
            
            // Обновляем размеры
            segment.highlightArea.width = newWidth;
            segment.highlightArea.height = newHeight;
            
            // Перецентрируем область вокруг маркера
            segment.highlightArea.x = centerX - newWidth / 2;
            segment.highlightArea.y = centerY - newHeight / 2;
            
            // Обновляем attachmentPoint (должен остаться в центре)
            segment.attachmentPoint.x = centerX;
            segment.attachmentPoint.y = centerY;
            
            // Обновляем отображение значений
            document.getElementById('segmentWidthValue').textContent = newWidth + 'px';
            document.getElementById('segmentHeightValue').textContent = newHeight + 'px';
            
            // Перерисовываем канвас
            renderBodyCanvas(body);
            updateCanvasInfo();
        }

        function resetSegmentSize() {
            if (!selectedSegmentId || !currentBodyId) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            const segment = body.segments[selectedSegmentId];
            
            if (!segment || !segment.highlightArea) return;
            
            // Сохраняем центральную точку (где находится маркер)
            const centerX = segment.highlightArea.x + segment.highlightArea.width / 2;
            const centerY = segment.highlightArea.y + segment.highlightArea.height / 2;
            
            // Устанавливаем стандартные размеры
            segment.highlightArea.width = 80;
            segment.highlightArea.height = 80;
            segment.highlightArea.x = centerX - 40;
            segment.highlightArea.y = centerY - 40;
            
            // Обновляем attachmentPoint (должен остаться в центре)
            segment.attachmentPoint.x = centerX;
            segment.attachmentPoint.y = centerY;
            
            updateSegmentScaleControls();
            renderBodyCanvas(body);
            updateCanvasInfo();
        }

        function setupResizeHandle(handle, segment) {
            handle.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                isResizing = true;
                
                resizeData.startX = e.clientX;
                resizeData.startY = e.clientY;
                resizeData.startWidth = segment.highlightArea.width;
                resizeData.startHeight = segment.highlightArea.height;
                
                document.addEventListener('mousemove', onResizeMove);
                document.addEventListener('mouseup', onResizeEnd);
            });
            
            function onResizeMove(e) {
                if (!isResizing) return;
                
                const deltaX = e.clientX - resizeData.startX;
                const deltaY = e.clientY - resizeData.startY;
                
                const newWidth = Math.max(20, resizeData.startWidth + deltaX);
                const newHeight = Math.max(20, resizeData.startHeight + deltaY);
                
                // Получаем центр области (где находится маркер)
                const centerX = segment.highlightArea.x + segment.highlightArea.width / 2;
                const centerY = segment.highlightArea.y + segment.highlightArea.height / 2;
                
                // Обновляем размеры и перецентрируем
                segment.highlightArea.width = newWidth;
                segment.highlightArea.height = newHeight;
                segment.highlightArea.x = centerX - newWidth / 2;
                segment.highlightArea.y = centerY - newHeight / 2;
                
                // Обновляем позицию треугольной ручки
                handle.style.left = (segment.highlightArea.x + newWidth) + 'px';
                handle.style.top = (segment.highlightArea.y + newHeight) + 'px';
                
                // Обновляем область подсветки
                const highlight = document.querySelector(`[data-segment-id="${segment.id}"].highlight-area`);
                if (highlight) {
                    highlight.style.left = segment.highlightArea.x + 'px';
                    highlight.style.top = segment.highlightArea.y + 'px';
                    highlight.style.width = newWidth + 'px';
                    highlight.style.height = newHeight + 'px';
                }
                
                updateSegmentScaleControls();
            }
            
            function onResizeEnd() {
                if (!isResizing) return;
                
                isResizing = false;
                updateCanvasInfo();
                
                document.removeEventListener('mousemove', onResizeMove);
                document.removeEventListener('mouseup', onResizeEnd);
            }
        }

        function updateSpritePath() {
            const newPath = document.getElementById('spritePath').value;
            spritesBasePath = newPath;
            
            // Обновляем пути в существующих данных
            Object.values(spritesData.baseBodies).forEach(body => {
                const fileName = body.sprite.split('/').pop();
                body.sprite = spritesBasePath + 'base-bodies/' + fileName;
            });
            
            Object.values(spritesData.decorativeElements).forEach(element => {
                const fileName = element.sprite.split('/').pop();
                element.sprite = spritesBasePath + 'decorative/' + fileName;
            });
            
            // Обновляем отображение
            updateBodyList();
            updateDecorativeElements();
            if (currentBodyId) {
                renderBodyCanvas(spritesData.baseBodies[currentBodyId]);
            }
        }

        function addNewDecorativeElement() {
            const nameInput = document.getElementById('newElementName');
            const segmentSelect = document.getElementById('newElementSegment');
            
            const name = nameInput.value.trim();
            const segmentType = segmentSelect.value;
            
            if (!name) return;
            
            const elementId = name.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
            
            spritesData.decorativeElements[elementId] = {
                id: elementId,
                name: name,
                sprite: spritesBasePath + 'decorative/' + elementId + '.png',
                segmentType: segmentType
            };
            
            nameInput.value = '';
            updateDecorativeElements();
        }
    </script>
</body>
</html>