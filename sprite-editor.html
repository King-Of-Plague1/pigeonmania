<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä Sprites.json - –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≥–æ–ª—É–±–µ–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
            font-size: 2em;
        }

        .header p {
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 80vh;
        }

        .sidebar {
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .file-button:hover {
            background: #0056b3;
        }

        .body-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .body-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .body-item:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .body-item.active {
            border-color: #007bff;
            background: #e6f3ff;
        }

        .body-preview {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-right: 10px;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .body-name {
            flex: 1;
            font-weight: 500;
        }

        .segments-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .segment-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }

        .segment-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .segment-icon {
            font-size: 16px;
        }

        .segment-name {
            font-size: 14px;
            font-weight: 500;
        }

        .delete-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-button:hover {
            background: #c82333;
        }

        .add-segment {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .add-segment input,
        .add-segment select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .add-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-button:hover {
            background: #218838;
        }

        .canvas-area {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .canvas-container {
            position: relative;
            display: inline-block;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
        }

        .base-body-image {
            max-width: 400px;
            max-height: 500px;
            display: block;
        }

        .segment-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            background: rgba(0, 123, 255, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            user-select: none;
            transform: translate(-50%, -50%);
            z-index: 20;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .segment-marker:hover {
            background: rgba(0, 123, 255, 1);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .segment-marker.dragging {
            background: rgba(255, 193, 7, 0.9);
            border-color: #ffc107;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }

        .highlight-area {
            position: absolute;
            border: 2px dashed rgba(0, 123, 255, 0.5);
            background: rgba(0, 123, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            pointer-events: none;
            z-index: 10;
        }

        .highlight-area.selected {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.2);
            pointer-events: auto;
        }

        .resize-handle {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 16px solid transparent;
            border-bottom: 16px solid #007bff;
            cursor: se-resize;
            z-index: 15;
            transition: all 0.2s ease;
        }

        .resize-handle:hover {
            border-bottom-color: #0056b3;
            transform: scale(1.15);
        }

        .resize-handle:before {
            content: '';
            position: absolute;
            top: 3px;
            left: -11px;
            width: 0;
            height: 0;
            border-left: 11px solid transparent;
            border-bottom: 11px solid white;
        }

        .resize-handle:after {
            content: '‚§°';
            position: absolute;
            top: -8px;
            left: -12px;
            font-size: 10px;
            color: #007bff;
            font-weight: bold;
            pointer-events: none;
        }

        .canvas-info {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 500px;
        }

        .canvas-info h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .coordinates {
            font-family: monospace;
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }

        .export-import {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-button,
        .import-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-button {
            background: #28a745;
            color: white;
        }

        .export-button:hover {
            background: #218838;
        }

        .import-button {
            background: #17a2b8;
            color: white;
        }

        .import-button:hover {
            background: #138496;
        }

        .no-body-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #6c757d;
            font-size: 18px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .decorative-elements {
            max-height: 300px;
            overflow-y: auto;
        }

        .element-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .element-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .element-preview {
            width: 20px;
            height: 20px;
            object-fit: contain;
            background: #f8f9fa;
            border-radius: 2px;
        }

        .segment-type {
            font-size: 10px;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            color: #6c757d;
        }

        .scale-section {
            margin-bottom: 20px;
        }

        .scale-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .scale-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .scale-control input[type="range"] {
            flex: 1;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .scale-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
        }

        .scale-control input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .scale-control span {
            min-width: 40px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #6c757d;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .scale-group {
            margin-bottom: 15px;
        }

        .scale-group label {
            font-size: 13px;
            margin-bottom: 5px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üê¶ –†–µ–¥–∞–∫—Ç–æ—Ä Sprites.json</h1>
            <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –∏ –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –≥–æ–ª—É–±–µ–π</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <!-- –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç -->
                <div class="panel">
                    <h3>–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h3>
                    
                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–∏ –∫ —Å–ø—Ä–∞–π—Ç–∞–º -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #6c757d;">–ë–∞–∑–æ–≤—ã–π –ø—É—Ç—å –∫ —Å–ø—Ä–∞–π—Ç–∞–º:</label>
                        <select id="spritePath" onchange="updateSpritePath()" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                            <option value="public/sprites/">public/sprites/ (–ª–æ–∫–∞–ª—å–Ω–æ)</option>
                            <option value="/sprites/">/sprites/ (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)</option>
                            <option value="./sprites/">./sprites/ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π)</option>
                            <option value="../public/sprites/">../public/sprites/ (–∏–∑ src)</option>
                        </select>
                    </div>
                    
                    <div class="file-input-wrapper">
                        <input type="file" id="importFile" class="file-input" accept=".json">
                        <button class="file-button" onclick="document.getElementById('importFile').click()">
                            üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å sprites.json
                        </button>
                    </div>
                    <div class="export-import">
                        <button class="export-button" onclick="exportConfig()">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
                        <button class="import-button" onclick="document.getElementById('importFile').click()">üì• –ò–º–ø–æ—Ä—Ç</button>
                    </div>
                </div>

                <!-- –ë–∞–∑–æ–≤—ã–µ —Ç–µ–ª–∞ -->
                <div class="panel">
                    <h3>–ë–∞–∑–æ–≤—ã–µ —Ç–µ–ª–∞</h3>
                    <div class="body-list" id="bodyList">
                        <!-- –¢–µ–ª–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    <div class="add-segment">
                        <input type="text" id="newBodyName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–∞">
                        <button class="add-button" onclick="addNewBody()">+</button>
                    </div>
                </div>

                <!-- –°–µ–≥–º–µ–Ω—Ç—ã -->
                <div class="panel">
                    <h3>–°–µ–≥–º–µ–Ω—Ç—ã</h3>
                    <div class="segments-list" id="segmentsList">
                        <!-- –°–µ–≥–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    <div class="add-segment">
                        <input type="text" id="newSegmentName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞">
                        <button class="add-button" onclick="addNewSegment()">+</button>
                    </div>
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div class="panel" id="scalePanel" style="display: none;">
                    <h3>–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                    
                    <!-- –ú–∞—Å—à—Ç–∞–± –±–∞–∑–æ–≤–æ–≥–æ —Ç–µ–ª–∞ -->
                    <div class="scale-section">
                        <label>–ú–∞—Å—à—Ç–∞–± —Ç–µ–ª–∞:</label>
                        <div class="scale-control">
                            <input type="range" id="bodyScale" min="0.5" max="2" step="0.1" value="1" onchange="updateBodyScale(this.value)">
                            <span id="bodyScaleValue">1.0</span>
                        </div>
                    </div>

                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ -->
                    <div class="scale-section" id="segmentScaleSection" style="display: none;">
                        <label id="selectedSegmentLabel">–í—ã–±—Ä–∞–Ω–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç:</label>
                        
                        <div class="scale-group">
                            <label>–®–∏—Ä–∏–Ω–∞ –æ–±–ª–∞—Å—Ç–∏:</label>
                            <div class="scale-control">
                                <input type="range" id="segmentWidth" min="20" max="200" step="5" onchange="updateSegmentSize()">
                                <span id="segmentWidthValue">0</span>
                            </div>
                        </div>
                        
                        <div class="scale-group">
                            <label>–í—ã—Å–æ—Ç–∞ –æ–±–ª–∞—Å—Ç–∏:</label>
                            <div class="scale-control">
                                <input type="range" id="segmentHeight" min="20" max="200" step="5" onchange="updateSegmentSize()">
                                <span id="segmentHeightValue">0</span>
                            </div>
                        </div>

                        <button class="add-button" onclick="resetSegmentSize()" style="width: 100%; margin-top: 10px;">
                            –°–±—Ä–æ—Å–∏—Ç—å —Ä–∞–∑–º–µ—Ä
                        </button>
                    </div>
                </div>

                <!-- –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
                <div class="panel">
                    <h3>–î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã</h3>
                    <div class="decorative-elements" id="decorativeElements">
                        <!-- –≠–ª–µ–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    <div class="add-segment">
                        <input type="text" id="newElementName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞">
                        <select id="newElementSegment" style="flex: 1; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <option value="head">–ì–æ–ª–æ–≤–∞</option>
                            <option value="wing">–ö—Ä—ã–ª–æ</option>
                        </select>
                        <button class="add-button" onclick="addNewDecorativeElement()">+</button>
                    </div>
                </div>
            </div>

            <div class="canvas-area">
                <div class="canvas-container" id="canvasContainer">
                    <div class="no-body-selected" id="noBodySelected">
                        –í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑–æ–≤–æ–µ —Ç–µ–ª–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    </div>
                    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –º–∞—Ä–∫–µ—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                    <div class="canvas-info" id="canvasInfo" style="display: none;">
                    <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ–≥–º–µ–Ω—Ç–∞—Ö</h4>
                    <div class="canvas-controls-info" style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 6px; padding: 10px; margin-bottom: 15px; font-size: 12px; color: #1565c0;">
                        üí° <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong><br>
                        üîµ –°–∏–Ω–∏–π –∫—Ä—É–≥ = –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏<br>
                        üî∂ –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ = –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞<br>
                        üéØ –ö–ª–∏–∫ –ø–æ –æ–±–ª–∞—Å—Ç–∏ = –≤—ã–±–æ—Ä —Å–µ–≥–º–µ–Ω—Ç–∞
                    </div>
                    <div class="coordinates" id="coordinatesInfo">
                        <!-- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let spritesData = {
            baseBodies: {},
            decorativeElements: {}
        };
        let currentBodyId = null;
        let selectedSegmentId = null;
        let isDragging = false;
        let isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        let resizeData = { startX: 0, startY: 0, startWidth: 0, startHeight: 0 };
        let spritesBasePath = 'public/sprites/';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultConfig();
            setupFileInput();
        });

        function loadDefaultConfig() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            spritesData = {
                baseBodies: {
                    "body1": {
                        "id": "body1",
                        "name": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≥–æ–ª—É–±—å",
                        "sprite": spritesBasePath + "base-bodies/body1.png",
                        "segments": {
                            "head": {
                                "id": "head",
                                "name": "–ì–æ–ª–æ–≤–∞",
                                "icon": "üê¶",
                                "attachmentPoint": { "x": 120, "y": 60 },
                                "highlightArea": { "x": 100, "y": 40, "width": 80, "height": 80 }
                            },
                            "wing": {
                                "id": "wing",
                                "name": "–ö—Ä—ã–ª–æ",
                                "icon": "ü™∂",
                                "attachmentPoint": { "x": 80, "y": 120 },
                                "highlightArea": { "x": 60, "y": 100, "width": 100, "height": 80 }
                            }
                        }
                    },
                    "body2": {
                        "id": "body2",
                        "name": "–ì–æ—Ä–æ–¥—Å–∫–æ–π –≥–æ–ª—É–±—å",
                        "sprite": spritesBasePath + "base-bodies/body2.png",
                        "segments": {
                            "head": {
                                "id": "head",
                                "name": "–ì–æ–ª–æ–≤–∞",
                                "icon": "üê¶",
                                "attachmentPoint": { "x": 110, "y": 55 },
                                "highlightArea": { "x": 90, "y": 35, "width": 75, "height": 75 }
                            },
                            "wing": {
                                "id": "wing",
                                "name": "–ö—Ä—ã–ª–æ",
                                "icon": "ü™∂",
                                "attachmentPoint": { "x": 75, "y": 115 },
                                "highlightArea": { "x": 55, "y": 95, "width": 95, "height": 75 }
                            }
                        }
                    }
                },
                decorativeElements: {
                    "crown": {
                        "id": "crown",
                        "name": "–ö–æ—Ä–æ–Ω–∞",
                        "sprite": spritesBasePath + "decorative/crown.png",
                        "segmentType": "head"
                    },
                    "hat": {
                        "id": "hat",
                        "name": "–®–ª—è–ø–∞",
                        "sprite": spritesBasePath + "decorative/hat.png",
                        "segmentType": "head"
                    },
                    "bow": {
                        "id": "bow",
                        "name": "–ë–∞–Ω—Ç–∏–∫",
                        "sprite": spritesBasePath + "decorative/bow.png",
                        "segmentType": "wing"
                    },
                    "ribbon": {
                        "id": "ribbon",
                        "name": "–õ–µ–Ω—Ç–∞",
                        "sprite": spritesBasePath + "decorative/ribbon.png",
                        "segmentType": "wing"
                    }
                }
            };
            
            updateBodyList();
            updateDecorativeElements();
        }

        function setupFileInput() {
            document.getElementById('importFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            spritesData = JSON.parse(e.target.result);
                            updateBodyList();
                            updateDecorativeElements();
                            if (currentBodyId) {
                                selectBody(currentBodyId);
                            }
                            alert('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
                        } catch (error) {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            });
        }

        function updateBodyList() {
            const bodyList = document.getElementById('bodyList');
            bodyList.innerHTML = '';

            Object.values(spritesData.baseBodies).forEach(body => {
                const bodyItem = document.createElement('div');
                bodyItem.className = `body-item ${currentBodyId === body.id ? 'active' : ''}`;
                bodyItem.onclick = () => selectBody(body.id);
                
                bodyItem.innerHTML = `
                    <img src="${body.sprite}" alt="${body.name}" class="body-preview" onerror="this.style.display='none'">
                    <span class="body-name">${body.name}</span>
                    <button class="delete-button" onclick="event.stopPropagation(); deleteBody('${body.id}')">√ó</button>
                `;
                
                bodyList.appendChild(bodyItem);
            });
        }

        function updateDecorativeElements() {
            const elementsContainer = document.getElementById('decorativeElements');
            elementsContainer.innerHTML = '';

            Object.values(spritesData.decorativeElements).forEach(element => {
                const elementItem = document.createElement('div');
                elementItem.className = 'element-item';
                
                elementItem.innerHTML = `
                    <div class="element-info">
                        <img src="${element.sprite}" alt="${element.name}" class="element-preview" onerror="this.style.display='none'">
                        <span>${element.name}</span>
                        <span class="segment-type">${element.segmentType}</span>
                    </div>
                    <button class="delete-button" onclick="deleteDecorativeElement('${element.id}')">√ó</button>
                `;
                
                elementsContainer.appendChild(elementItem);
            });
        }

        function selectBody(bodyId) {
            currentBodyId = bodyId;
            selectedSegmentId = null;
            const body = spritesData.baseBodies[bodyId];
            
            updateBodyList();
            updateSegmentsList();
            renderBodyCanvas(body);
            updateCanvasInfo();
            showScalePanel();
            updateScaleControls();
        }

        function renderBodyCanvas(body) {
            const container = document.getElementById('canvasContainer');
            const noBodySelected = document.getElementById('noBodySelected');
            
            container.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–ª–∞
            const img = document.createElement('img');
            img.src = body.sprite;
            img.className = 'base-body-image';
            img.alt = body.name;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–±, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (body.scale) {
                img.style.transform = `scale(${body.scale})`;
                img.style.transformOrigin = 'top left';
            }
            
            img.onload = function() {
                container.appendChild(img);
                renderSegmentMarkers(body);
            };
            
            img.onerror = function() {
                const placeholder = document.createElement('div');
                placeholder.style.width = '300px';
                placeholder.style.height = '400px';
                placeholder.style.background = '#f8f9fa';
                placeholder.style.border = '2px dashed #dee2e6';
                placeholder.style.display = 'flex';
                placeholder.style.alignItems = 'center';
                placeholder.style.justifyContent = 'center';
                placeholder.style.color = '#6c757d';
                placeholder.textContent = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
                container.appendChild(placeholder);
                renderSegmentMarkers(body);
            };
        }

        function renderSegmentMarkers(body) {
            const container = document.getElementById('canvasContainer');
            
            Object.values(body.segments).forEach(segment => {
                // –°–æ–∑–¥–∞–µ–º –æ–±–ª–∞—Å—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–Ω–∞—á–∞–ª–∞ (—á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –ø–æ–¥ –º–∞—Ä–∫–µ—Ä–æ–º)
                if (segment.highlightArea) {
                    const highlight = document.createElement('div');
                    highlight.className = `highlight-area ${selectedSegmentId === segment.id ? 'selected' : ''}`;
                    highlight.style.left = segment.highlightArea.x + 'px';
                    highlight.style.top = segment.highlightArea.y + 'px';
                    highlight.style.width = segment.highlightArea.width + 'px';
                    highlight.style.height = segment.highlightArea.height + 'px';
                    highlight.dataset.segmentId = segment.id;
                    highlight.title = `–û–±–ª–∞—Å—Ç—å: ${segment.name}`;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π
                    if (selectedSegmentId !== segment.id) {
                        highlight.style.pointerEvents = 'auto';
                        highlight.addEventListener('click', function(e) {
                            e.preventDefault();
                            selectSegment(segment.id);
                        });
                    }
                    
                    container.appendChild(highlight);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ—É–≥–æ–ª—å–Ω—É—é —Ä—É—á–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
                    if (selectedSegmentId === segment.id) {
                        const resizeHandle = document.createElement('div');
                        resizeHandle.className = 'resize-handle';
                        resizeHandle.style.left = (segment.highlightArea.x + segment.highlightArea.width) + 'px';
                        resizeHandle.style.top = (segment.highlightArea.y + segment.highlightArea.height) + 'px';
                        resizeHandle.dataset.segmentId = segment.id;
                        
                        setupResizeHandle(resizeHandle, segment);
                        
                        container.appendChild(resizeHandle);
                    }
                }

                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Ç–æ—á–∫–∏ –∫—Ä–µ–ø–ª–µ–Ω–∏—è –≤ —Ü–µ–Ω—Ç—Ä–µ –æ–±–ª–∞—Å—Ç–∏ (–ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ)
                const marker = document.createElement('div');
                marker.className = 'segment-marker';
                marker.textContent = segment.icon;
                marker.dataset.segmentId = segment.id;
                marker.title = segment.name;
                
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–∞—Ä–∫–µ—Ä –≤ —Ü–µ–Ω—Ç—Ä–µ –æ–±–ª–∞—Å—Ç–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                if (segment.highlightArea) {
                    const centerX = segment.highlightArea.x + segment.highlightArea.width / 2;
                    const centerY = segment.highlightArea.y + segment.highlightArea.height / 2;
                    marker.style.left = centerX + 'px';
                    marker.style.top = centerY + 'px';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º attachmentPoint —á—Ç–æ–±—ã –æ–Ω —Å–æ–≤–ø–∞–¥–∞–ª —Å —Ü–µ–Ω—Ç—Ä–æ–º
                    segment.attachmentPoint.x = centerX;
                    segment.attachmentPoint.y = centerY;
                } else {
                    marker.style.left = segment.attachmentPoint.x + 'px';
                    marker.style.top = segment.attachmentPoint.y + 'px';
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º drag and drop
                setupDragAndDrop(marker, segment);
                
                container.appendChild(marker);
            });
        }

        function setupDragAndDrop(marker, segment) {
            marker.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ –∫ –æ–±–ª–∞—Å—Ç–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                isDragging = true;
                marker.classList.add('dragging');
                
                const rect = marker.getBoundingClientRect();
                const containerRect = document.getElementById('canvasContainer').getBoundingClientRect();
                
                dragOffset.x = e.clientX - rect.left - rect.width / 2;
                dragOffset.y = e.clientY - rect.top - rect.height / 2;
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            
            function onMouseMove(e) {
                if (!isDragging) return;
                
                const containerRect = document.getElementById('canvasContainer').getBoundingClientRect();
                const centerX = Math.max(0, e.clientX - containerRect.left - dragOffset.x);
                const centerY = Math.max(0, e.clientY - containerRect.top - dragOffset.y);
                
                marker.style.left = centerX + 'px';
                marker.style.top = centerY + 'px';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–∞—Å—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                if (segment.highlightArea) {
                    const halfWidth = segment.highlightArea.width / 2;
                    const halfHeight = segment.highlightArea.height / 2;
                    
                    segment.highlightArea.x = centerX - halfWidth;
                    segment.highlightArea.y = centerY - halfHeight;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏
                    const highlight = document.querySelector(`[data-segment-id="${segment.id}"].highlight-area`);
                    if (highlight) {
                        highlight.style.left = segment.highlightArea.x + 'px';
                        highlight.style.top = segment.highlightArea.y + 'px';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä—É—á–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞, –µ—Å–ª–∏ —Å–µ–≥–º–µ–Ω—Ç –≤—ã–±—Ä–∞–Ω
                    if (selectedSegmentId === segment.id) {
                        const resizeHandle = document.querySelector(`[data-segment-id="${segment.id}"].resize-handle`);
                        if (resizeHandle) {
                            resizeHandle.style.left = (segment.highlightArea.x + segment.highlightArea.width) + 'px';
                            resizeHandle.style.top = (segment.highlightArea.y + segment.highlightArea.height) + 'px';
                        }
                    }
                }
            }
            
            function onMouseUp(e) {
                if (!isDragging) return;
                
                isDragging = false;
                marker.classList.remove('dragging');
                
                const containerRect = document.getElementById('canvasContainer').getBoundingClientRect();
                const centerX = Math.max(0, e.clientX - containerRect.left - dragOffset.x);
                const centerY = Math.max(0, e.clientY - containerRect.top - dragOffset.y);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç–∞
                segment.attachmentPoint.x = Math.round(centerX);
                segment.attachmentPoint.y = Math.round(centerY);
                
                if (segment.highlightArea) {
                    const halfWidth = segment.highlightArea.width / 2;
                    const halfHeight = segment.highlightArea.height / 2;
                    
                    segment.highlightArea.x = Math.round(centerX - halfWidth);
                    segment.highlightArea.y = Math.round(centerY - halfHeight);
                }
                
                updateCanvasInfo();
                
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        }

        function updateSegmentsList() {
            const segmentsList = document.getElementById('segmentsList');
            segmentsList.innerHTML = '';
            
            if (!currentBodyId) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            Object.values(body.segments).forEach(segment => {
                const segmentItem = document.createElement('div');
                segmentItem.className = 'segment-item';
                
                segmentItem.innerHTML = `
                    <div class="segment-info">
                        <span class="segment-icon">${segment.icon}</span>
                        <span class="segment-name">${segment.name}</span>
                    </div>
                    <button class="delete-button" onclick="deleteSegment('${segment.id}')">√ó</button>
                `;
                
                segmentsList.appendChild(segmentItem);
            });
        }

        function updateCanvasInfo() {
            const canvasInfo = document.getElementById('canvasInfo');
            const coordinatesInfo = document.getElementById('coordinatesInfo');
            
            if (!currentBodyId) {
                canvasInfo.style.display = 'none';
                return;
            }
            
            canvasInfo.style.display = 'block';
            
            const body = spritesData.baseBodies[currentBodyId];
            let info = `–ë–∞–∑–æ–≤–æ–µ —Ç–µ–ª–æ: ${body.name}\n`;
            
            if (body.scale && body.scale !== 1.0) {
                info += `–ú–∞—Å—à—Ç–∞–±: ${body.scale}\n`;
            }
            
            info += `–ü—É—Ç—å –∫ —Å–ø—Ä–∞–π—Ç–∞–º: ${spritesBasePath}\n`;
            info += '\n';
            
            Object.values(body.segments).forEach(segment => {
                const isSelected = selectedSegmentId === segment.id;
                const marker = isSelected ? '‚ñ∫ ' : '  ';
                
                info += `${marker}${segment.name} (${segment.icon}):\n`;
                info += `  attachmentPoint: { x: ${segment.attachmentPoint.x}, y: ${segment.attachmentPoint.y} }\n`;
                if (segment.highlightArea) {
                    info += `  highlightArea: { x: ${segment.highlightArea.x}, y: ${segment.highlightArea.y}, width: ${segment.highlightArea.width}, height: ${segment.highlightArea.height} }\n`;
                }
                info += '\n';
            });
            
            if (selectedSegmentId) {
                info += `\nüí° –í—ã–±—Ä–∞–Ω —Å–µ–≥–º–µ–Ω—Ç: ${body.segments[selectedSegmentId]?.name}\n`;
                info += `–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –æ–±–ª–∞—Å—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞`;
            }
            
            coordinatesInfo.textContent = info;
        }

        function addNewSegment() {
            const input = document.getElementById('newSegmentName');
            const name = input.value.trim();
            
            if (!name || !currentBodyId) return;
            
            const segmentId = name.toLowerCase().replace(/\s+/g, '_');
            const body = spritesData.baseBodies[currentBodyId];
            
            if (body.segments[segmentId]) {
                alert('–°–µ–≥–º–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                return;
            }
            
            body.segments[segmentId] = {
                id: segmentId,
                name: name,
                icon: 'üìç',
                attachmentPoint: { x: 100, y: 100 },
                highlightArea: { x: 80, y: 80, width: 40, height: 40 }
            };
            
            input.value = '';
            updateSegmentsList();
            renderBodyCanvas(body);
            updateCanvasInfo();
        }

        function deleteSegment(segmentId) {
            if (!currentBodyId || !confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç?')) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            delete body.segments[segmentId];
            
            updateSegmentsList();
            renderBodyCanvas(body);
            updateCanvasInfo();
        }

        function addNewBody() {
            const input = document.getElementById('newBodyName');
            const name = input.value.trim();
            
            if (!name) return;
            
            const bodyId = 'body_' + Date.now();
            
            spritesData.baseBodies[bodyId] = {
                id: bodyId,
                name: name,
                sprite: spritesBasePath + 'base-bodies/' + bodyId + '.png',
                segments: {}
            };
            
            input.value = '';
            updateBodyList();
            selectBody(bodyId);
        }

        function deleteBody(bodyId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –±–∞–∑–æ–≤–æ–µ —Ç–µ–ª–æ?')) return;
            
            delete spritesData.baseBodies[bodyId];
            
            if (currentBodyId === bodyId) {
                currentBodyId = null;
                document.getElementById('canvasContainer').innerHTML = '<div class="no-body-selected">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑–æ–≤–æ–µ —Ç–µ–ª–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>';
                document.getElementById('canvasInfo').style.display = 'none';
                updateSegmentsList();
            }
            
            updateBodyList();
        }

        function deleteDecorativeElement(elementId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç?')) return;
            
            delete spritesData.decorativeElements[elementId];
            updateDecorativeElements();
        }

        function exportConfig() {
            const dataStr = JSON.stringify(spritesData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'sprites.json';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        function showScalePanel() {
            document.getElementById('scalePanel').style.display = 'block';
        }

        function updateScaleControls() {
            if (!currentBodyId) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            const bodyScaleSlider = document.getElementById('bodyScale');
            const bodyScaleValue = document.getElementById('bodyScaleValue');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—à—Ç–∞–± —Ç–µ–ª–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (!body.scale) {
                body.scale = 1.0;
            }
            
            bodyScaleSlider.value = body.scale;
            bodyScaleValue.textContent = body.scale.toFixed(1);
            
            updateSegmentScaleControls();
        }

        function updateSegmentScaleControls() {
            const segmentScaleSection = document.getElementById('segmentScaleSection');
            
            if (!selectedSegmentId || !currentBodyId) {
                segmentScaleSection.style.display = 'none';
                return;
            }
            
            const body = spritesData.baseBodies[currentBodyId];
            const segment = body.segments[selectedSegmentId];
            
            if (!segment || !segment.highlightArea) {
                segmentScaleSection.style.display = 'none';
                return;
            }
            
            segmentScaleSection.style.display = 'block';
            
            document.getElementById('selectedSegmentLabel').textContent = `${segment.name} (${segment.icon}):`;
            
            const widthSlider = document.getElementById('segmentWidth');
            const heightSlider = document.getElementById('segmentHeight');
            const widthValue = document.getElementById('segmentWidthValue');
            const heightValue = document.getElementById('segmentHeightValue');
            
            widthSlider.value = segment.highlightArea.width;
            heightSlider.value = segment.highlightArea.height;
            widthValue.textContent = segment.highlightArea.width + 'px';
            heightValue.textContent = segment.highlightArea.height + 'px';
        }

        function selectSegment(segmentId) {
            selectedSegmentId = segmentId;
            if (currentBodyId) {
                renderBodyCanvas(spritesData.baseBodies[currentBodyId]);
                updateSegmentScaleControls();
            }
        }

        function updateBodyScale(scale) {
            if (!currentBodyId) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            body.scale = parseFloat(scale);
            
            document.getElementById('bodyScaleValue').textContent = scale;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–± –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
            const img = document.querySelector('.base-body-image');
            if (img) {
                img.style.transform = `scale(${scale})`;
                img.style.transformOrigin = 'top left';
            }
        }

        function updateSegmentSize() {
            if (!selectedSegmentId || !currentBodyId) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            const segment = body.segments[selectedSegmentId];
            
            if (!segment || !segment.highlightArea) return;
            
            const newWidth = parseInt(document.getElementById('segmentWidth').value);
            const newHeight = parseInt(document.getElementById('segmentHeight').value);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É (–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –º–∞—Ä–∫–µ—Ä)
            const centerX = segment.highlightArea.x + segment.highlightArea.width / 2;
            const centerY = segment.highlightArea.y + segment.highlightArea.height / 2;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã
            segment.highlightArea.width = newWidth;
            segment.highlightArea.height = newHeight;
            
            // –ü–µ—Ä–µ—Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å –≤–æ–∫—Ä—É–≥ –º–∞—Ä–∫–µ—Ä–∞
            segment.highlightArea.x = centerX - newWidth / 2;
            segment.highlightArea.y = centerY - newHeight / 2;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º attachmentPoint (–¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –≤ —Ü–µ–Ω—Ç—Ä–µ)
            segment.attachmentPoint.x = centerX;
            segment.attachmentPoint.y = centerY;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
            document.getElementById('segmentWidthValue').textContent = newWidth + 'px';
            document.getElementById('segmentHeightValue').textContent = newHeight + 'px';
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–Ω–≤–∞—Å
            renderBodyCanvas(body);
            updateCanvasInfo();
        }

        function resetSegmentSize() {
            if (!selectedSegmentId || !currentBodyId) return;
            
            const body = spritesData.baseBodies[currentBodyId];
            const segment = body.segments[selectedSegmentId];
            
            if (!segment || !segment.highlightArea) return;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É (–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –º–∞—Ä–∫–µ—Ä)
            const centerX = segment.highlightArea.x + segment.highlightArea.width / 2;
            const centerY = segment.highlightArea.y + segment.highlightArea.height / 2;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            segment.highlightArea.width = 80;
            segment.highlightArea.height = 80;
            segment.highlightArea.x = centerX - 40;
            segment.highlightArea.y = centerY - 40;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º attachmentPoint (–¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –≤ —Ü–µ–Ω—Ç—Ä–µ)
            segment.attachmentPoint.x = centerX;
            segment.attachmentPoint.y = centerY;
            
            updateSegmentScaleControls();
            renderBodyCanvas(body);
            updateCanvasInfo();
        }

        function setupResizeHandle(handle, segment) {
            handle.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                isResizing = true;
                
                resizeData.startX = e.clientX;
                resizeData.startY = e.clientY;
                resizeData.startWidth = segment.highlightArea.width;
                resizeData.startHeight = segment.highlightArea.height;
                
                document.addEventListener('mousemove', onResizeMove);
                document.addEventListener('mouseup', onResizeEnd);
            });
            
            function onResizeMove(e) {
                if (!isResizing) return;
                
                const deltaX = e.clientX - resizeData.startX;
                const deltaY = e.clientY - resizeData.startY;
                
                const newWidth = Math.max(20, resizeData.startWidth + deltaX);
                const newHeight = Math.max(20, resizeData.startHeight + deltaY);
                
                // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—Ç—Ä –æ–±–ª–∞—Å—Ç–∏ (–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –º–∞—Ä–∫–µ—Ä)
                const centerX = segment.highlightArea.x + segment.highlightArea.width / 2;
                const centerY = segment.highlightArea.y + segment.highlightArea.height / 2;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏ –ø–µ—Ä–µ—Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
                segment.highlightArea.width = newWidth;
                segment.highlightArea.height = newHeight;
                segment.highlightArea.x = centerX - newWidth / 2;
                segment.highlightArea.y = centerY - newHeight / 2;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç—Ä–µ—É–≥–æ–ª—å–Ω–æ–π —Ä—É—á–∫–∏
                handle.style.left = (segment.highlightArea.x + newWidth) + 'px';
                handle.style.top = (segment.highlightArea.y + newHeight) + 'px';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–∞—Å—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                const highlight = document.querySelector(`[data-segment-id="${segment.id}"].highlight-area`);
                if (highlight) {
                    highlight.style.left = segment.highlightArea.x + 'px';
                    highlight.style.top = segment.highlightArea.y + 'px';
                    highlight.style.width = newWidth + 'px';
                    highlight.style.height = newHeight + 'px';
                }
                
                updateSegmentScaleControls();
            }
            
            function onResizeEnd() {
                if (!isResizing) return;
                
                isResizing = false;
                updateCanvasInfo();
                
                document.removeEventListener('mousemove', onResizeMove);
                document.removeEventListener('mouseup', onResizeEnd);
            }
        }

        function updateSpritePath() {
            const newPath = document.getElementById('spritePath').value;
            spritesBasePath = newPath;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            Object.values(spritesData.baseBodies).forEach(body => {
                const fileName = body.sprite.split('/').pop();
                body.sprite = spritesBasePath + 'base-bodies/' + fileName;
            });
            
            Object.values(spritesData.decorativeElements).forEach(element => {
                const fileName = element.sprite.split('/').pop();
                element.sprite = spritesBasePath + 'decorative/' + fileName;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            updateBodyList();
            updateDecorativeElements();
            if (currentBodyId) {
                renderBodyCanvas(spritesData.baseBodies[currentBodyId]);
            }
        }

        function addNewDecorativeElement() {
            const nameInput = document.getElementById('newElementName');
            const segmentSelect = document.getElementById('newElementSegment');
            
            const name = nameInput.value.trim();
            const segmentType = segmentSelect.value;
            
            if (!name) return;
            
            const elementId = name.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
            
            spritesData.decorativeElements[elementId] = {
                id: elementId,
                name: name,
                sprite: spritesBasePath + 'decorative/' + elementId + '.png',
                segmentType: segmentType
            };
            
            nameInput.value = '';
            updateDecorativeElements();
        }
    </script>
</body>
</html>